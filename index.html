<!DOCTYPE html>
<html>
<head>
    <title>EarthCloudEarthquake</title>
    <script src="three.js"></script>
    <script src="OrbitControls.js"></script>
    <script src="stats.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<script>
// global variables
var renderer;
var scene;
var camera;
var control;
var stats;
var cameraControl;
var video, videoImage, videoImageContext, videoTexture;

/**
     * Initializes the scene, camera and objects. Called when the window is
     * loaded by using window.onload (see below)
     */
function init() {
  // create a scene, that will hold all our elements such as objects, cameras and lights.
  scene = new THREE.Scene();

  // create a camera, which defines where we're looking at.
  camera = new THREE.PerspectiveCamera(
    45,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
  );

  // create a render, sets the background color and the size
  renderer = new THREE.WebGLRenderer();
  renderer.setClearColor(0x000000, 1.0);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.Enabled = true;

  // create a sphere
  var sphereGeometry = new THREE.SphereGeometry(15, 60, 60);
  var sphereMaterial = createEarthMaterial();
  var earthMesh = new THREE.Mesh(sphereGeometry, sphereMaterial);
  earthMesh.name = "earth";
  scene.add(earthMesh);

  // position and point the camera to the center of the scene
  camera.position.x = 25;
  camera.position.y = 26;
  camera.position.z = 23;
  camera.lookAt(scene.position);

  // add controls
  cameraControl = new THREE.OrbitControls(camera);

  control = new function() {
    this.rotationSpeed = 0.001;
  }();

  addStatsObject();

  document.body.appendChild(renderer.domElement);

  render();
}

function createEarthMaterial() {
  video = document.createElement("video");
  video.src = "sst2017.mp4";
  video.load(); // must call after setting/changing source
  video.play();

  videoImage = document.createElement("canvas");
  videoImage.width = 1024;
  videoImage.height = 512;

  videoImageContext = videoImage.getContext("2d");
  // background color if no video present
  videoImageContext.fillStyle = "#000000";
  videoImageContext.fillRect(0, 0, videoImage.width, videoImage.height);

  videoTexture = new THREE.Texture(videoImage);
  videoTexture.minFilter = THREE.LinearFilter;
  videoTexture.magFilter = THREE.LinearFilter;

  var earthMaterial = new THREE.MeshBasicMaterial({
    map: videoTexture
  });

  return earthMaterial;
}

function addStatsObject() {
  stats = new Stats();
  stats.setMode(0);

  stats.domElement.style.position = "absolute";
  stats.domElement.style.left = "0px";
  stats.domElement.style.top = "0px";

  document.body.appendChild(stats.domElement);
}

/**
     * Called when the scene needs to be rendered. Delegates to requestAnimationFrame
     * for future renders
     */
function render() {
  // update stats
  stats.update();

  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    videoImageContext.drawImage(video, 0, 0);
    if (videoTexture) videoTexture.needsUpdate = true;
  }

  // update the camera
  cameraControl.update();

  // scene.getObjectByName("earth").rotation.y += control.rotationSpeed;
  // scene.getObjectByName("overlay").rotation.y += control.rotationSpeed;
  // scene.getObjectByName("clouds").rotation.y += control.rotationSpeed * 1.1;

  // and render the scene
  renderer.render(scene, camera);

  // render using requestAnimationFrame
  requestAnimationFrame(render);
}

/**
     * Function handles the resize event. This make sure the camera and the renderer
     * are updated at the correct moment.
     */
function handleResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

// calls the init function when the window is done loading.
window.onload = init;
// calls the handleResize function when the window is resized
window.addEventListener("resize", handleResize, false);
</script>
<body>
</body>
</html>
